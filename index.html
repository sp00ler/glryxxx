<!-- index.html -->
<!DOCTYPE html>
<html lang="ru" data-theme="auto">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Галерея изображений</title>

<!-- PWA / iOS A2HS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Галерея">
<link rel="apple-touch-icon" href="icon-180.png"> <!-- 180x180 -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0e0f11">

<style>
    :root{
        --bg:#0e0f11; --text:#e9e9e9; --panel:#17181b; --muted:#a0a0a0;
        --btn:#24262b; --btn-text:#e9e9e9; --btn-hover:#2d3036;
        --overlay:rgba(0,0,0,0.96); --glass:rgba(255,255,255,0.14);
        --accent:#4da3ff; --accent-contrast:#000;
        --thumb-w:54px; --thumb-h:38px; /* регулируется слайдером */
        --thumb-border:#0008; --thumb-active:#4da3ff;
    }
    html[data-theme="light"] :root{
        --bg:#f4f4f4; --text:#111; --panel:#ffffff; --muted:#666;
        --btn:#e9e9e9; --btn-text:#111; --btn-hover:#d9d9d9;
        --overlay:rgba(0,0,0,0.96); --glass:rgba(0,0,0,0.35);
        --accent:#007bff; --accent-contrast:#fff;
        --thumb-border:#fff8; --thumb-active:#007bff;
    }

    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .gallery-container{max-width:1200px;margin:auto;padding:15px;padding-bottom:calc(15px + env(safe-area-inset-bottom))}
    .controls{
        background:var(--panel);border-radius:10px;padding:10px;
        display:flex;flex-wrap:wrap;gap:8px;justify-content:center;align-items:center;
        box-shadow:0 1px 3px rgba(0,0,0,.12);position:sticky;top:env(safe-area-inset-top,0);z-index:5
    }
    .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;margin-top:12px}
    .gallery img{
        width:100%;height:120px;object-fit:cover;border-radius:8px;transition:transform .18s, box-shadow .18s, opacity .2s;cursor:pointer;background:#0001
    }
    .gallery img:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(0,0,0,.18)}
    input[type=file]{padding:6px 8px;background:var(--btn);color:var(--btn-text);border-radius:8px;border:1px solid transparent}
    .btn, select{
        padding:8px 12px;font-size:14px;border:1px solid transparent;border-radius:8px;background:var(--btn);color:var(--btn-text);cursor:pointer;transition:background .15s, transform .05s
    }
    .btn:hover, select:hover{background:var(--btn-hover)}
    .btn:active{transform:translateY(1px)}
    .btn-accent{background:var(--accent);color:var(--accent-contrast)}
    .error{color:#ff6b6b;text-align:center;margin-top:10px;min-height:1.2em}

    /* Fullscreen viewer */
    .fullscreen{
        position:fixed;inset:0;background:var(--overlay);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:1000;touch-action:pan-y
    }
    .fullscreen img{max-width:95%;max-height:72vh;transition:opacity .25s;opacity:0;user-select:none;-webkit-user-drag:none}
    .fs-ui{position:absolute;inset:0;display:flex;flex-direction:column;pointer-events:none}
    .fs-top{display:flex;justify-content:flex-end;gap:8px;padding:12px;pointer-events:auto}
    .fs-bottom{margin-top:auto;display:flex;flex-direction:column;gap:8px;pointer-events:none}
    .fullscreen-controls{display:flex;gap:12px;justify-content:center;padding-bottom:10px;pointer-events:auto}
    .ctrl{
        padding:10px 12px;font-size:16px;border:none;border-radius:10px;background:var(--glass);color:#fff;cursor:pointer;backdrop-filter:blur(6px)
    }
    .ctrl:hover{filter:brightness(1.1)}
    .counter{
        position:absolute;left:14px;bottom:14px;font-size:12px;color:#fff;opacity:.85;padding:4px 8px;border-radius:6px;background:var(--glass);backdrop-filter:blur(6px);line-height:1;pointer-events:none;min-width:38px;text-align:center
    }

    /* progress */
    .progress{height:6px;background:rgba(255,255,255,.08);pointer-events:none}
    .progress__bar{height:100%;width:0%;background:var(--accent);transition:width .25s}

    /* thumbs */
    .thumbs{
        display:flex;gap:6px;padding:6px 10px;overflow-x:auto;scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.3) transparent;
        -webkit-overflow-scrolling:touch;justify-content:center;pointer-events:auto
    }
    .thumb{
        width:var(--thumb-w);height:var(--thumb-h);flex:0 0 auto;border-radius:6px;overflow:hidden;cursor:pointer;outline:1px solid var(--thumb-border)
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .thumb.active{outline:2px solid var(--thumb-active);box-shadow:0 0 0 2px var(--thumb-active) inset}

    /* settings panel */
    .settings{
        position:relative;display:inline-block
    }
    .settings-panel{
        position:absolute;right:0;top:110%;background:var(--panel);border-radius:10px;padding:10px;min-width:220px;box-shadow:0 8px 24px rgba(0,0,0,.25);display:none;z-index:10
    }
    .settings.open .settings-panel{display:block}
    .row{display:flex;align-items:center;justify-content:space-between;gap:8px;margin:6px 0}
    .row label{font-size:13px;color:var(--muted)}
    .switch{display:inline-flex;align-items:center;gap:6px}
    .switch input{appearance:none;width:38px;height:22px;border-radius:999px;background:var(--btn);position:relative;outline:none;cursor:pointer}
    .switch input:checked{background:var(--accent)}
    .switch input::after{content:"";position:absolute;top:3px;left:3px;width:16px;height:16px;border-radius:50%;background:#fff;transition:left .2s}
    .switch input:checked::after{left:19px}
    input[type=range]{width:120px}

    /* autohide */
    .autohide .fs-top, .autohide .fs-bottom, .autohide .fullscreen-controls, .autohide .counter{opacity:0;pointer-events:none;transition:opacity .2s}
    .fs-top, .fs-bottom, .fullscreen-controls, .counter{transition:opacity .2s}

    @media (min-width:600px){ .gallery img{height:150px} }
</style>
</head>
<body>
<div class="gallery-container">
    <div class="controls">
        <input type="file" id="fileInput" accept="image/*" multiple>
        <div class="switch">
            <label for="modeSwitch">Режим:</label>
            <select id="modeSwitch">
                <option value="order">По порядку</option>
                <option value="random" selected>Случайный</option>
            </select>
        </div>
        <button class="btn" id="toggleSlideshow">Старт</button>
        <select id="intervalSelect" title="Интервал показа">
            <option value="2">2 сек</option>
            <option value="3">3 сек</option>
            <option value="5" selected>5 сек</option>
            <option value="7">7 сек</option>
        </select>
        <button class="btn" id="toggleTheme">Тема: авто</button>

        <div class="settings" id="settings">
            <button class="btn" id="btnSettings">⚙︎ Настройки</button>
            <div class="settings-panel">
                <div class="row">
                    <label>Размер превью</label>
                    <input id="thumbSize" type="range" min="40" max="90" value="54">
                </div>
                <div class="row">
                    <label>Автоскрытие панелей</label>
                    <label class="switch"><input type="checkbox" id="autoHideToggle" checked></label>
                </div>
                <div class="row">
                    <label>Таймаут, с</label>
                    <input id="autoHideTimeout" type="range" min="2" max="10" value="4">
                </div>
            </div>
        </div>
    </div>

    <div class="error" id="errorMessage"></div>
    <div class="gallery" id="gallery"></div>
</div>

<div class="fullscreen" id="fullscreen">
    <img id="fullscreenImage" src="" alt="">
    <div class="fs-ui" id="fsUi">
        <div class="fs-top">
            <button class="ctrl" id="closeBtn" aria-label="Закрыть">✕</button>
        </div>
        <div class="fs-bottom">
            <div class="thumbs" id="thumbs"></div>
            <div class="progress"><div class="progress__bar" id="progressBar"></div></div>
            <div class="fullscreen-controls">
                <button class="ctrl" id="prevBtn" aria-label="Предыдущее">⟨</button>
                <button class="ctrl" id="nextBtn" aria-label="Следующее">⟩</button>
            </div>
        </div>
    </div>
    <div class="counter" id="counter">0/0</div>
</div>

<script>
let images = [];
let currentIndex = 0;
let isSlideshowRunning = false;
let slideshowInterval = null;

let mode = localStorage.getItem('mode') || 'random'; // 'random' | 'order'
let playlist = [];    // последовательность индексов без повторов
let playPtr = -1;     // текущая позиция в плейлисте

// История для «назад/вперёд»
const backStack = [];
const forwardStack = [];

const $ = (id)=>document.getElementById(id);
const errorMessage = $('errorMessage');
const gallery = $('gallery');
const fullscreen = $('fullscreen');
const fsUi = $('fsUi');
const fullscreenImage = $('fullscreenImage');
const counter = $('counter');
const toggleBtn = $('toggleSlideshow');
const themeBtn = $('toggleTheme');
const thumbs = $('thumbs');
const progressBar = $('progressBar');
const modeSwitch = $('modeSwitch');
const btnSettings = $('btnSettings');
const settings = $('settings');
const thumbSize = $('thumbSize');
const autoHideToggle = $('autoHideToggle');
const autoHideTimeout = $('autoHideTimeout');

modeSwitch.value = mode;

/* ---------- Тема: авто/светлая/тёмная ---------- */
(function initTheme(){
    const saved = localStorage.getItem('gallery-theme');
    setTheme(saved || 'auto');
    themeBtn.addEventListener('click', () => {
        const mapping = { 'auto':'light', 'light':'dark', 'dark':'auto' };
        const current = document.documentElement.getAttribute('data-theme') || 'auto';
        const next = mapping[current] || 'auto';
        setTheme(next);
        localStorage.setItem('gallery-theme', next);
    });
})();
function setTheme(mode){
    document.documentElement.setAttribute('data-theme', mode);
    themeBtn.textContent = 'Тема: ' + (mode === 'auto' ? 'авто' : (mode === 'light' ? 'светлая' : 'тёмная'));
}

/* ---------- Настройки UI ---------- */
thumbSize.addEventListener('input', ()=>{
    document.documentElement.style.setProperty('--thumb-w', thumbSize.value+'px');
    document.documentElement.style.setProperty('--thumb-h', Math.round(thumbSize.value*0.7)+'px');
});
autoHideToggle.addEventListener('change', saveUiPrefs);
autoHideTimeout.addEventListener('input', saveUiPrefs);
function saveUiPrefs(){
    localStorage.setItem('ui-prefs', JSON.stringify({
        autoHide: autoHideToggle.checked,
        timeout: Number(autoHideTimeout.value),
        thumb: Number(thumbSize.value)
    }));
}
(function loadUiPrefs(){
    const p = JSON.parse(localStorage.getItem('ui-prefs') || '{}');
    if (p.thumb){ thumbSize.value = p.thumb; thumbSize.dispatchEvent(new Event('input')); }
    if (typeof p.autoHide === 'boolean') autoHideToggle.checked = p.autoHide;
    if (p.timeout) autoHideTimeout.value = p.timeout;
})();

// меню настроек
btnSettings.addEventListener('click', (e)=>{
    e.stopPropagation();
    settings.classList.toggle('open');
});
document.addEventListener('click', ()=>settings.classList.remove('open'));

/* ---------- Утилиты ---------- */
function showError(msg){ errorMessage.textContent = msg; }
function clearError(){ errorMessage.textContent=''; }
function updateCounter(){
    const A = images.length ? (currentIndex + 1) : 0;
    const B = images.length;
    counter.textContent = `${A}/${B}`;
}
function updateProgress(){
    if (!images.length) return progressBar.style.width='0%';
    progressBar.style.width = ((currentIndex+1)/images.length*100)+'%';
}
function highlightActiveThumb(){
    const nodes = thumbs.querySelectorAll('.thumb');
    nodes.forEach((n,i)=> n.classList.toggle('active', i===currentIndex));
    const active = thumbs.querySelector('.thumb.active');
    if (active){
        active.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
    }
}

/* ---------- Плейлист без повторов ---------- */
function makePlaylist(){
    playlist = Array.from({length: images.length}, (_,i)=>i);
    if (mode === 'random') shuffleInPlace(playlist);
    playPtr = -1;
}
function shuffleInPlace(a){
    for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
    }
}
function nextFromPlaylist(){
    if (playPtr+1 >= playlist.length) return null; // конец
    playPtr++;
    return playlist[playPtr];
}
function prevFromHistory(){
    if (backStack.length){
        const prev = backStack.pop();
        forwardStack.push(currentIndex);
        return prev;
    }
    return null;
}

/* ---------- Загрузка изображений ---------- */
$('fileInput').addEventListener('change', (e) => {
    clearError();
    images = [];
    backStack.length = 0; forwardStack.length = 0;
    gallery.innerHTML = ''; thumbs.innerHTML = '';

    const files = Array.from(e.target.files || []);
    for (let file of files) {
        if (!file.type.startsWith('image/')) continue;
        const url = URL.createObjectURL(file);
        images.push(url);

        const t = document.createElement('div');
        t.className='thumb';
        const ti=document.createElement('img');
        ti.src=url; ti.alt=file.name; ti.loading='lazy'; ti.decoding='async';
        t.appendChild(ti);
        t.addEventListener('click', ()=> {
            // прыжок: сохраняем историю и чистим forward
            backStack.push(currentIndex);
            forwardStack.length = 0;
            currentIndex = images.indexOf(url);
            // подогнать плейлист так, чтобы playPtr указывал на текущий
            playPtr = playlist.indexOf(currentIndex);
            swapFullscreenImage(false);
        });
        thumbs.appendChild(t);

        const img = document.createElement('img');
        img.src=url; img.alt=file.name; img.loading='lazy'; img.decoding='async';
        img.onclick=()=>showFullscreen(images.indexOf(url));
        gallery.appendChild(img);
    }
    if (!images.length) return showError('Не удалось загрузить изображения');

    makePlaylist(); // новый список без повторов
    updateCounter(); updateProgress();
});

/* ---------- Fullscreen ---------- */
function showFullscreen(index){
    if (index<0 || index>=images.length) return;
    currentIndex = index;
    // выставим playPtr на текущий индекс в плейлисте (если пользователь открыл вручную)
    playPtr = playlist.indexOf(currentIndex);
    fullscreen.style.display='flex';
    fullscreenImage.style.opacity=0;
    fullscreenImage.src = images[currentIndex];
    requestAnimationFrame(()=> fullscreenImage.style.opacity=1);
    updateCounter(); updateProgress(); highlightActiveThumb();
    wakeUi();
}
function exitFullscreen(){
    fullscreen.style.display='none';
    stopSlideshow();
}
function swapFullscreenImage(){
    fullscreenImage.style.opacity=0;
    setTimeout(()=>{
        fullscreenImage.src = images[currentIndex];
        fullscreenImage.onload = ()=> (fullscreenImage.style.opacity=1);
        updateCounter(); updateProgress(); highlightActiveThumb();
    },110);
}

/* ---------- Навигация ---------- */
$('prevBtn').addEventListener('click', ()=> {
    const prev = prevFromHistory();
    if (prev!==null){
        currentIndex = prev;
        playPtr = playlist.indexOf(currentIndex);
        swapFullscreenImage();
    } else {
        // если истории нет — просто шаг назад по плейлисту (без зацикливания)
        if (playPtr>0){
            playPtr--;
            currentIndex = playlist[playPtr];
            swapFullscreenImage();
        }
    }
    wakeUi();
});
$('nextBtn').addEventListener('click', ()=> {
    // ручной «вперёд» идёт по плейлисту, без повторов и без круга
    const next = nextFromPlaylist();
    if (next===null) {
        stopSlideshow(true);
        return;
    }
    backStack.push(currentIndex);
    forwardStack.length = 0;
    currentIndex = next;
    swapFullscreenImage();
    wakeUi();
});
$('closeBtn').addEventListener('click', exitFullscreen);

document.addEventListener('keydown', (e)=>{
    if (fullscreen.style.display==='flex'){
        if (e.key==='ArrowLeft') $('prevBtn').click();
        if (e.key==='ArrowRight') $('nextBtn').click();
        if (e.key==='Escape') exitFullscreen();
    }
});

/* Свайпы для мобильных */
let touchStartX=0;
fullscreen.addEventListener('touchstart', (e)=>{ touchStartX = e.changedTouches[0].screenX; wakeUi(); }, {passive:true});
fullscreen.addEventListener('touchend', (e)=>{
    let diff = e.changedTouches[0].screenX - touchStartX;
    if (diff>50) $('prevBtn').click();
    else if (diff<-50) $('nextBtn').click();
}, {passive:true});

/* Клик по фону для закрытия */
fullscreen.addEventListener('click', (e)=>{ if (e.target===fullscreen) exitFullscreen(); });

/* ---------- Слайдшоу ---------- */
$('intervalSelect').addEventListener('change', ()=>{
    if (isSlideshowRunning){ stopSlideshow(); startSlideshow(); }
});
toggleBtn.addEventListener('click', ()=>{
    isSlideshowRunning ? stopSlideshow() : startSlideshow();
});
modeSwitch.addEventListener('change', ()=>{
    mode = modeSwitch.value;
    localStorage.setItem('mode', mode);
    makePlaylist();
    // если открыто, синхронизируем указатель с текущим
    playPtr = playlist.indexOf(currentIndex);
});

function startSlideshow(){
    if (!images.length) return showError('Загрузите изображения');
    if (fullscreen.style.display!=='flex') showFullscreen(0);
    isSlideshowRunning = true;
    toggleBtn.textContent='Стоп';
    // если плейлист закончился — пересоберём
    if (playPtr >= playlist.length-1) makePlaylist(), playPtr=-1;

    const step = ()=>{
        const next = nextFromPlaylist();
        if (next===null){ // достигли конца — стоп, без круга
            stopSlideshow(true);
            return;
        }
        backStack.push(currentIndex);
        forwardStack.length=0;
        currentIndex = next;
        swapFullscreenImage();
    };
    step(); // сразу показать первый шаг
    const interval = parseInt($('intervalSelect').value)*1000;
    slideshowInterval = setInterval(step, interval);
}
function stopSlideshow(end=false){
    isSlideshowRunning=false;
    toggleBtn.textContent='Старт';
    clearInterval(slideshowInterval);
    if (end){
        // мягкое уведомление — можно заменить на тост
        counter.textContent += ' • конец';
        wakeUi();
    }
}

/* ---------- Автоскрытие панелей в fullscreen ---------- */
let hideTimer = null;
function scheduleHide(){
    if (!autoHideToggle.checked) return;
    clearTimeout(hideTimer);
    const ms = Number(autoHideTimeout.value)*1000;
    hideTimer = setTimeout(()=> fullscreen.classList.add('autohide'), ms);
}
function wakeUi(){
    fullscreen.classList.remove('autohide');
    scheduleHide();
}
// любое движение/тап в зоне fullscreen — разбудить UI
['mousemove','touchstart','click'].forEach(ev=>{
    fullscreen.addEventListener(ev, ()=>wakeUi(), {passive:true});
});

/* ---------- Очистка URL ---------- */
window.addEventListener('beforeunload', ()=> images.forEach(u=>URL.revokeObjectURL(u)));
</script>

<script>
// Регистрация service worker (для A2HS/офлайн оболочки)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', ()=> {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}
</script>
</body>
</html>
